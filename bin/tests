#!/bin/bash
#
# Run tests and report coverage.

set -e

opts=(-v
       --cov=pyrediq
       --cov-report term-missing
       --log-format="%(asctime)s %(levelname)s %(thread)d %(message)s")

# Tests to run can be specified explicitly or all tests are run:
if [[ $# -eq 0 ]]; then
  opts+=(tests/)
else
  opts+=("$@")
fi

for package in pytest pytest-cov pytest-capturelog mock ; do
  if ! python -c "import $package" 2> /dev/null; then
    pip install -U "$package"
  fi
done

pytest "${opts[@]}"
